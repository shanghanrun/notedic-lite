import { pb } from "./pb.svelte"; // ê¸°ì¡´ì— ë§Œë“  í¬ì¼“ë² ì´ìŠ¤ ì¸ìŠ¤í„´ìŠ¤

class ChatManager {
    // --- [ìƒíƒœ ë³€ìˆ˜ë“¤] ---
    rooms = $state([]);
    activeRoomId = $state(null);
    messages = $state([]);
    newMessage = $state("");
    newRoomTitle = $state("");
	users =$state([])
	onlineMap = $state({}) //ì˜¨ë¼ì¸ ìƒíƒœ ê´€ë¦¬

    // --- [ìœ ë„ëœ ìƒíƒœ (Derived)] ---
    // í˜„ì¬ userê°€ ì„ íƒëœ ë°© ê°ì²´
    get currentRoom() {
        return this.rooms.find(r => r.id === this.activeRoomId);
    }

    // ë‚´ê°€ í˜„ì¬ ë°©ì˜ ë©¤ë²„ì¸ì§€ í™•ì¸
    get isMember() {
        if (!this.currentRoom || !pb.authStore.model) return false;
        return this.currentRoom.members?.includes(pb.authStore.model.id);
    }

    // --- [ë©”ì„œë“œ (í•¨ìˆ˜ë“¤)] ---

    // 1. ì´ˆê¸° ë°ì´í„° ë¡œë“œ ë° êµ¬ë…
    async init() {
        this.rooms = await pb.collection("rooms").getFullList({ sort: "-created" });
        
        // ì‹¤ì‹œê°„ ë°© ëª©ë¡ êµ¬ë…
        pb.collection("rooms").subscribe("*", ({ action, record }) => {
            if (action === "create") this.rooms = [record, ...this.rooms];
            if (action === "update") {
                this.rooms = this.rooms.map(r => r.id === record.id ? record : r);
            }
        });
    }

    // 2. ë°© ë§Œë“¤ê¸° (ìƒì„±ì ìë™ í¬í•¨)
    async createRoom() {
        if (!this.newRoomTitle.trim()) return alert("ë°© ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”!");

        try {
            const data = {
                title: this.newRoomTitle,
                active: true,
                owner: pb.authStore.model.id,
                members: [pb.authStore.model.id] // ë§Œë“  ì‚¬ëŒì€ ìë™ìœ¼ë¡œ ë©¤ë²„ ì¶”ê°€
            };

            const record = await pb.collection("rooms").create(data);
            // this.rooms = [...this.rooms, record];   // ë°©ë§Œ ì¶”ê°€í•˜ê³ , ë°©ì˜ ëª©ë¡ì€ êµ¬ë…ë¡œì§ì—ì„œ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ê²Œ í•´ì•¼ ì¤‘ë³µì´ ì•ˆëœë‹¤.
            this.activeRoomId = record.id;
            this.newRoomTitle = "";
            console.log("âœ… ë°© ìƒì„± ë° ìë™ ì…ì¥ ì„±ê³µ!");
        } catch (err) {
            console.error("âŒ ë°© ìƒì„± ì‹¤íŒ¨:", err);
        }
    }
	// 2. ìœ ì € ì´ˆëŒ€ (ë©”ì‹œì§€ ë°œì†¡)
    async inviteUser(targetUser) {
        if (!this.activeRoomId) return alert("ë°©ì„ ë¨¼ì € ë§Œë“¤ê³  ì´ˆëŒ€í•˜ì„¸ìš”.");

        try {
            await pb.collection("messages").create({
                room: this.activeRoomId,
                user: pb.authStore.model.id,
                content: `ğŸ”” [ì‹œìŠ¤í…œ] ${targetUser.name}ë‹˜ì„ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤.`,
                type: 'invitation', // ì´ˆëŒ€ ë©”ì‹œì§€ íƒ€ì… êµ¬ë¶„
                target_user: targetUser.id
            });
            alert(`${targetUser.name}ë‹˜ì„ ì´ˆëŒ€í–ˆìŠµë‹ˆë‹¤!`);
        } catch (err) {
            console.error("âŒ ì´ˆëŒ€ ë©”ì‹œì§€ ì‹¤íŒ¨:", err);
        }
    }

    // 3. ë°© ì…ì¥í•˜ê¸°
    async joinRoom() {
        try {
            const newMembers = [...(this.currentRoom.members || []), pb.authStore.model.id];
            const record = await pb.collection("rooms").update(this.activeRoomId, {
                members: newMembers
            });
            
            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ ë°œì†¡
            await pb.collection("messages").create({
                room: this.activeRoomId,
                user: pb.authStore.model.id,
                content: `ğŸ“¢ ${pb.authStore.model.name}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`
            });

            // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í•˜ë‚˜ ì´ì£¼ê¸°
        	await this.sendSystemMessage(`ğŸ“¢ ${pb.authStore.model.name || 'ìœ ì €'}ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`);
        } catch (err) {
            console.error("âŒ ì…ì¥ ì‹¤íŒ¨:", err);
        }        
    }

    // 4. ë©”ì‹œì§€ ì „ì†¡
    async sendMessage() {
        if (!this.newMessage.trim() || !this.activeRoomId) return;
        await pb.collection("messages").create({
            room: this.activeRoomId,
            user: pb.authStore.model.id,
            content: this.newMessage
        });
        this.newMessage = "";
    }
	// ë©”ì‹œì§€ ë¡œë“œ (ë°© ë°”ë€” ë•Œë§ˆë‹¤ ì‹¤í–‰)
    async loadMessages(roomId) { // í•´ë‹¹ ë°©ì—ì„œ ì´ì „ì— ë‚˜ëˆ„ì—ˆë˜ ëŒ€í™” 50ê°œ ê¸ì–´ì™€ ë³´ì—¬ì£¼ê¸°
        this.activeRoomId = roomId;
        const list = await pb.collection("messages").getList(1, 50, {
            filter: `room = "${roomId}"`, //ì´ ë°©ì˜ ë©”ì‹œì§€ë§Œ ê³¨ë¼ë‚´ê³ 
            sort: 'created', // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬í•˜ê³ 
            expand: 'user' // ê³ ìœ  ì™¸ê³„ì–´ IDëŒ€ì‹ ì—,ì´ë¦„ ì •ë³´ê¹Œì§€ ì±™ê²¨ì˜¤ë„ë¡ 
        });
        this.messages = list.items;
    }

    async sendSystemMessage(content) {
        await pb.collection("messages").create({
            room: this.activeRoomId,
            user: pb.authStore.model.id, // ì‹œìŠ¤í…œ ê³„ì •ì´ ë”°ë¡œ ì—†ë‹¤ë©´ í˜„ì¬ ìœ ì €ë¡œ
            content: content
        });
    }
}

// ì‹±ê¸€í†¤ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
export const chatManager = new ChatManager();